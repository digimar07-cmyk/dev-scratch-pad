"""\nCore ‚Äî AI Analyzer\nAn√°lise de projetos com IA (categorias e tags)\n"""\n\nimport os\nfrom config import LOGGER, FAST_MODEL_THRESHOLD\nfrom core.project_structure import ProjectStructureAnalyzer\nfrom core.tag_extractor import TagExtractor\n\n\nclass AIAnalyzer:\n    def __init__(self, ollama_text_gen, ollama_vision, stop_flag=None):\n        self.text_gen = ollama_text_gen\n        self.vision = ollama_vision\n        self.stop_flag = stop_flag\n\n    def _choose_text_role(self, batch_size=1):\n        """Escolhe modelo r√°pido para lotes grandes, qualidade para an√°lise individual."""\n        if batch_size > FAST_MODEL_THRESHOLD:\n            return "text_fast"\n        return "text_quality"\n\n    def _find_first_image_path(self, project_path):\n        """Retorna caminho da primeira imagem v√°lida encontrada."""\n        valid_extensions = (".png", ".jpg", ".jpeg", ".gif", ".bmp", ".webp")\n        try:\n            for item in os.listdir(project_path):\n                if item.lower().endswith(valid_extensions):\n                    return os.path.join(project_path, item)\n        except Exception:\n            LOGGER.exception(f"Falha ao listar {project_path}")\n        return None\n\n    def analyze_with_ai(self, project_path, batch_size=1):\n        """\n        Analisa um projeto e retorna (categories, tags).\n        Integra vis√£o (moondream) quando h√° imagem de capa dispon√≠vel.\n        Usa qwen2.5:7b para an√°lise individual, :3b para lotes grandes.\n        """\n        try:\n            name = os.path.basename(project_path)\n            structure = ProjectStructureAnalyzer.analyze_project_structure(project_path)\n\n            file_types_str = ", ".join(\n                f"{ext} ({count}x)" for ext, count in structure["file_types"].items()\n            )\n            subfolders_str = (\n                ", ".join(structure["subfolders"][:5]) if structure["subfolders"] else "nenhuma"\n            )\n\n            tech_context = []\n            if structure["has_svg"]: tech_context.append("SVG vetorial")\n            if structure["has_pdf"]: tech_context.append("PDF")\n            if structure["has_dxf"]: tech_context.append("DXF/CAD")\n            if structure["has_ai"]:  tech_context.append("Adobe Illustrator")\n            tech_str = ", ".join(tech_context) if tech_context else "formatos variados"\n\n            # Tenta descri√ß√£o visual com moondream\n            vision_line = ""\n            cover_img = self._find_first_image_path(project_path)\n            if cover_img:\n                quality = self.vision.image_quality_score(cover_img)\n                if quality["use_vision"]:\n                    vision_desc = self.vision.describe_image(cover_img)\n                    if vision_desc:\n                        vision_line = f"\\nüñºÔ∏è DESCRI√á√ÉO VISUAL DA CAPA: {vision_desc}"\n\n            role = self._choose_text_role(batch_size)\n\n            # Prompt otimizado para Qwen2.5-Instruct\n            prompt = f"""Analise este produto de corte laser e responda EXATAMENTE no formato solicitado.\n\nüìÅ NOME: {name}\nüìä ARQUIVOS: {structure['total_files']} arquivos | Subpastas: {subfolders_str}\nüóÇÔ∏è TIPOS: {file_types_str}\nüîß FORMATOS: {tech_str}{vision_line}\n\n### TAREFA 1 ‚Äî CATEGORIAS\nAtribua de 3 a 5 categorias, OBRIGATORIAMENTE nesta ordem:\n1. Data Comemorativa (escolha UMA): P√°scoa, Natal, Dia das M√£es, Dia dos Pais, Dia dos Namorados, Anivers√°rio, Casamento, Ch√° de Beb√™, Halloween, Dia das Crian√ßas, Ano Novo, Formatura, Diversos\n2. Fun√ß√£o/Tipo (escolha UMA): Porta-Retrato, Caixa Organizadora, Lumin√°ria, Porta-Joias, Porta-Chaves, Suporte, Quadro Decorativo, Painel de Parede, Mandala, Nome Decorativo, Letreiro, Lembrancinha, Chaveiro, Topo de Bolo, Centro de Mesa, Plaquinha, Brinquedo Educativo, Diversos\n3. Ambiente (escolha UM): Quarto, Sala, Cozinha, Banheiro, Escrit√≥rio, Quarto Infantil, Quarto de Beb√™, √Årea Externa, Festa, Diversos\n4. Estilo OPCIONAL (ex: Minimalista, R√∫stico, Moderno, Vintage, Rom√¢ntico, Elegante)\n5. P√∫blico OPCIONAL (ex: Beb√™, Crian√ßa, Adulto, Casal, Fam√≠lia, Presente)\n\n### TAREFA 2 ‚Äî TAGS\nCrie exatamente 8 tags relevantes:\n- Primeiras 3: palavras-chave extra√≠das do nome \"{name}\" (sem c√≥digos num√©ricos)\n- Demais 5: emo√ß√£o, ocasi√£o, p√∫blico, estilo, uso\n\n### FORMATO DE RESPOSTA (siga exatamente):\nCategorias: [cat1], [cat2], [cat3], [cat4 opcional], [cat5 opcional]\nTags: [tag1], [tag2], [tag3], [tag4], [tag5], [tag6], [tag7], [tag8]"""\n\n            if self.stop_flag and getattr(self.stop_flag, "stop_analysis", False):\n                from core.fallback_analyzer import FallbackAnalyzer\n                return FallbackAnalyzer.fallback_analysis(project_path)\n\n            text = self.text_gen.generate_text(\n                prompt,\n                role=role,\n                temperature=0.65,\n                num_predict=200,\n            )\n\n            categories, tags = [], []\n\n            if text:\n                for line in text.split("\\n"):\n                    line = line.strip()\n                    if line.startswith("Categorias:") or line.startswith("Categories:"):\n                        raw = line.split(":", 1)[1].strip().replace("[", "").replace("]", "")\n                        categories = [c.strip().strip('\"') for c in raw.split(",") if c.strip()]\n                    elif line.startswith("Tags:"):\n                        raw = line.split(":", 1)[1].strip().replace("[", "").replace("]", "")\n                        tags = [t.strip().strip('\"') for t in raw.split(",") if t.strip()]\n\n                # Garante tags do nome sempre presentes\n                name_tags = TagExtractor.extract_tags_from_name(name)\n                for tag in name_tags:\n                    if tag not in tags:\n                        tags.insert(0, tag)\n\n                tags = list(dict.fromkeys(tags))[:10]  # deduplica e limita\n\n                if len(categories) < 3:\n                    from core.fallback_analyzer import FallbackAnalyzer\n                    categories = FallbackAnalyzer.fallback_categories(project_path, categories)\n\n                return categories[:8], tags\n\n        except Exception:\n            LOGGER.exception(f"Erro em analyze_with_ai para {project_path}")\n\n        from core.fallback_analyzer import FallbackAnalyzer\n        return FallbackAnalyzer.fallback_analysis(project_path)\n