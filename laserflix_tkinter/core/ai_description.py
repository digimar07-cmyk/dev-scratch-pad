"""\nCore — AI Description Generator\nGeração de descrições comerciais personalizadas\n"""\n\nimport os\nimport re\nfrom datetime import datetime\nfrom config import LOGGER\nfrom core.project_structure import ProjectStructureAnalyzer\n\n\nclass AIDescriptionGenerator:\n    def __init__(self, ollama_text_gen, ollama_vision, stop_flag=None):\n        self.text_gen = ollama_text_gen\n        self.vision = ollama_vision\n        self.stop_flag = stop_flag\n\n    def _find_first_image_path(self, project_path):\n        valid_extensions = (".png", ".jpg", ".jpeg", ".gif", ".bmp", ".webp")\n        try:\n            for item in os.listdir(project_path):\n                if item.lower().endswith(valid_extensions):\n                    return os.path.join(project_path, item)\n        except Exception:\n            LOGGER.exception(f"Falha ao listar {project_path}")\n        return None\n\n    def generate_ai_description(self, project_path, data, database_ref):\n        """\n        Gera descrição comercial personalizada.\n\n        HIERARQUIA (inviolável):\n          1° NOME da peça  — âncora absoluta. Define o que o produto É.\n          2° VISÃO (moondream) — detalhe visual SECUNDÁRIO, só se a imagem\n             passa no filtro de qualidade (image_quality_score).\n             Nunca contradiz nem substitui o nome.\n        """\n        if self.stop_flag and getattr(self.stop_flag, "stop_analysis", False):\n            return None\n\n        structure = None\n        try:\n            structure = (\n                data.get("structure")\n                or database_ref.get(project_path, {}).get("structure")\n            )\n            if not structure:\n                structure = ProjectStructureAnalyzer.analyze_project_structure(project_path)\n                if project_path in database_ref:\n                    database_ref[project_path]["structure"] = structure\n                else:\n                    data["structure"] = structure\n\n            # ── 1° NOME — âncora absoluta ────────────────────────────\n            raw_name = data.get("name", os.path.basename(project_path) or "Sem nome")\n            clean_name = raw_name\n            for ext in [".zip", ".rar", ".svg", ".pdf", ".dxf", ".cdr", ".ai"]:\n                clean_name = clean_name.replace(ext, "")\n            clean_name = re.sub(r"[-_]\\d{5,}", "", clean_name)\n            clean_name = clean_name.replace("-", " ").replace("_", " ").strip()\n\n            # ── 2° VISÃO — só se imagem passa no filtro ────────────────\n            vision_context = ""\n            cover_img = self._find_first_image_path(project_path)\n            if cover_img:\n                quality = self.vision.image_quality_score(cover_img)\n                if quality["use_vision"]:\n                    vision_desc = self.vision.describe_image(cover_img)\n                    if vision_desc:\n                        vision_context = "\\n\\nDETALHE VISUAL (use apenas para complementar, nunca contradizer o nome): " + vision_desc\n                else:\n                    LOGGER.info(\n                        f"⚠️ Visão desativada para {os.path.basename(project_path)} (brilho={quality['brightness']:.1f} sat={quality['saturation']:.1f} fundo~{quality['white_pct']:.1f}%)"\n                    )\n\n            if self.stop_flag and getattr(self.stop_flag, "stop_analysis", False):\n                return None\n\n            prompt = (\n                "Você é especialista em peças físicas de corte a laser — placas, espelhos, "\n                "porta-retratos, tabuletas, cabides, calendários, nomes decorativos e similares.\\n\\n"\n                "NOME DA PEÇA (use isso como verdade absoluta sobre o que é o produto): " + clean_name\n                + vision_context + "\\n\\n"\n                "### REGRA FUNDAMENTAL:\\n"\n                "O NOME define o que é o produto. O detalhe visual apenas complementa.\\n"\n                "Nunca invente função ou formato que contradiga o nome.\\n\\n"\n                "### RACIOCINE antes de escrever:\\n"\n                "1. O que exatamente é esta peça física, baseado no nome? (tipo de objeto)\\n"\n                "2. Para que serve na prática? (uso real no dia a dia)\\n"\n                "3. Que emoção ou momento ela representa? (conexão afetiva)\\n\\n"\n                "### ESCREVA a descrição EXATAMENTE neste formato (sem nada além disso):\\n\\n"\n                + clean_name + "\\n\\n"\n                "\\U0001f3a8 Por Que Este Produto é Especial:\\n"\n                "[2 a 3 frases afetivas e únicas. Fale sobre o que torna ESTA peça especial. "\n                "Nunca use frases genéricas que servem para qualquer produto.]\\n\\n"\n                "\\U0001f496 Perfeito Para:\\n"\n                "[2 a 3 frases práticas com exemplos reais de uso e ocasião para ESTA peça específica.]\\n\\n"\n                "### REGRAS OBRIGATÓRIAS:\\n"\n                "- Escreva em português brasileiro\\n"\n                "- Nunca use a palavra projeto — esta é uma PEÇA ou PRODUTO físico\\n"\n                "- Nunca mencione arquivos, SVG, PDF, formatos ou etapas de produção\\n"\n                "- Nunca repita frases que poderiam servir para qualquer outra peça\\n"\n                "- Máximo 120 palavras no total\\n"\n                "- Responda APENAS com o texto no formato acima, sem comentários adicionais"\n            )\n\n            response_text = self.text_gen.generate_text(\n                prompt,\n                role="text_quality",\n                temperature=0.78,\n                num_predict=250,\n            )\n\n            if response_text:\n                if not response_text.strip().startswith(clean_name[:15]):\n                    response_text = clean_name + "\\n\\n" + response_text.strip()\n                database_ref.setdefault(project_path, {})\n                database_ref[project_path]["ai_description"]           = response_text.strip()\n                database_ref[project_path]["description_generated_at"] = datetime.now().isoformat()\n                database_ref[project_path]["description_model"]        = self.text_gen.client.get_model_name("text_quality")\n                database_ref[project_path].setdefault("structure", structure)\n                return response_text.strip()\n\n            from core.fallback_analyzer import FallbackAnalyzer\n            return FallbackAnalyzer.generate_fallback_description(project_path, data, structure, database_ref)\n\n        except Exception as e:\n            LOGGER.error(f"Erro ao gerar descrição para {project_path}: {e}", exc_info=True)\n            from core.fallback_analyzer import FallbackAnalyzer\n            return FallbackAnalyzer.generate_fallback_description(\n                project_path, data,\n                structure or ProjectStructureAnalyzer.analyze_project_structure(project_path),\n                database_ref\n            )\n