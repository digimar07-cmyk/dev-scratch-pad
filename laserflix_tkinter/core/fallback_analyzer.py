"""\nCore — Fallback Analyzer\nAnálise e descrição sem IA (fallback quando Ollama offline)\n"""\n\nimport os\nimport re\nfrom datetime import datetime\nfrom core.tag_extractor import TagExtractor\n\n\nclass FallbackAnalyzer:\n    @staticmethod\n    def fallback_categories(project_path, existing_categories):\n        """Retorna categorias baseadas em padrões de nome."""\n        name = os.path.basename(project_path).lower()\n        date_map = {\n            "pascoa": "Páscoa", "easter": "Páscoa",\n            "natal": "Natal", "christmas": "Natal",\n            "mae": "Dia das Mães", "mother": "Dia das Mães",\n            "pai": "Dia dos Pais", "father": "Dia dos Pais",\n            "crianca": "Dia das Crianças", "children": "Dia das Crianças",\n            "baby": "Chá de Bebê", "bebe": "Chá de Bebê",\n            "wedding": "Casamento", "casamento": "Casamento",\n            "birthday": "Aniversário", "aniversario": "Aniversário",\n        }\n        function_map = {\n            "frame": "Porta-Retrato", "foto": "Porta-Retrato",\n            "box": "Caixa Organizadora", "caixa": "Caixa Organizadora",\n            "name": "Nome Decorativo", "nome": "Nome Decorativo",\n            "sign": "Plaquinha Divertida", "placa": "Plaquinha Divertida",\n            "quadro": "Quadro Decorativo", "painel": "Painel de Parede",\n        }\n        ambiente_map = {\n            "nursery": "Quarto de Bebê", "baby": "Quarto de Bebê",\n            "bedroom": "Quarto", "quarto": "Quarto",\n            "kitchen": "Cozinha", "cozinha": "Cozinha",\n            "living": "Sala", "sala": "Sala",\n            "kids": "Quarto Infantil", "infantil": "Quarto Infantil",\n        }\n        result = list(existing_categories)\n        date_cats = ["Páscoa", "Natal", "Dia das Mães", "Dia dos Pais", "Casamento", "Chá de Bebê", "Aniversário", "Dia das Crianças"]\n        if not any(c in date_cats for c in result):\n            for key, val in date_map.items():\n                if key in name:\n                    result.insert(0, val)\n                    break\n            else:\n                result.insert(0, "Diversos")\n        if len(result) < 2:\n            for key, val in function_map.items():\n                if key in name:\n                    result.append(val)\n                    break\n            else:\n                result.append("Diversos")\n        if len(result) < 3:\n            for key, val in ambiente_map.items():\n                if key in name:\n                    result.append(val)\n                    break\n            else:\n                result.append("Diversos")\n        return result\n\n    @staticmethod\n    def fallback_analysis(project_path):\n        """Análise completa sem IA."""\n        name = os.path.basename(project_path).lower()\n        name_tags = TagExtractor.extract_tags_from_name(os.path.basename(project_path))\n        categories = ["Diversos", "Diversos", "Diversos"]\n        context_tags = ["personalizado", "artesanal"]\n        checks = [\n            (["pascoa","easter","coelho"], 0, "Páscoa"),\n            (["natal","christmas","noel"], 0, "Natal"),\n            (["mae","mom","mother"],       0, "Dia das Mães"),\n            (["pai","dad","father"],       0, "Dia dos Pais"),\n            (["baby","bebe","shower"],     0, "Chá de Bebê"),\n            (["frame","foto","photo"],     1, "Porta-Retrato"),\n            (["box","caixa"],              1, "Caixa Organizadora"),\n            (["name","nome","sign"],       1, "Nome Decorativo"),\n            (["quadro","painel"],          1, "Quadro Decorativo"),\n            (["nursery","baby"],           2, "Quarto de Bebê"),\n            (["bedroom","quarto"],         2, "Quarto"),\n            (["kitchen","cozinha"],        2, "Cozinha"),\n            (["sala","living"],            2, "Sala"),\n        ]\n        for words, idx, val in checks:\n            if any(w in name for w in words):\n                categories[idx] = val\n        all_tags = name_tags + context_tags\n        seen, unique_tags = set(), []\n        for tag in all_tags:\n            if tag.lower() not in seen:\n                seen.add(tag.lower())\n                unique_tags.append(tag)\n        return categories, unique_tags[:10]\n\n    @staticmethod\n    def generate_fallback_description(project_path, data, structure, database_ref):\n        """\n        Fallback sem IA: respeita o formato obrigatório Nome / Especial / Perfeito Para.\n        Baseado no nome e tags — nunca menciona arquivos ou formatos.\n        """\n        raw_name = data.get("name", "Sem nome")\n        clean_name = raw_name\n        for ext in [".zip", ".rar", ".svg", ".pdf", ".dxf", ".cdr", ".ai"]:\n            clean_name = clean_name.replace(ext, "")\n        clean_name = re.sub(r"[-_]\\d{5,}", "", clean_name)\n        clean_name = clean_name.replace("-", " ").replace("_", " ").strip()\n\n        tags      = data.get("tags", [])\n        tags_lower = " ".join(tags).lower()\n        name_lower = clean_name.lower()\n\n        # Lógica condicional para diferentes tipos\n        if any(w in name_lower or w in tags_lower for w in ["hanger", "coat hanger", "cabide"]):\n            especial = (\n                "Um cabide infantil encantador que transforma o quarto da criança "\n                "em um cantinho cheio de personalidade e organização."\n            )\n            perfeito = (\n                "Perfeito para organizar roupinhas no quarto infantil com charme. "\n                "Ótimo presente para bebês e crianças em aniversários ou chá de bebê."\n            )\n        elif any(w in name_lower or w in tags_lower for w in ["mirror", "espelho"]):\n            especial = (\n                "Um espelho decorativo único, cortado a laser com precisão, "\n                "que combina funcionalidade e arte para o ambiente infantil."\n            )\n            perfeito = (\n                "Ideal para decorar quarto de bebê ou quarto infantil com estilo. "\n                "Um presente memorável para maternidades e enxovais."\n            )\n        elif any(w in name_lower or w in tags_lower for w in ["calendar", "calendário", "calendario"]):\n            especial = (\n                "Um calendário decorativo que une organização e arte, "\n                "tornando cada dia especial com detalhes únicos e lúdicos."\n            )\n            perfeito = (\n                "Perfeito para quartos infantis, escritórios ou como presente criativo. "\n                "Ideal para datas especiais e presentes personalizados."\n            )\n        else:\n            categories  = data.get("categories", ["Diversos"])\n            cat_display = " | ".join(categories[:3]) if categories else "Produto personalizado"\n            especial = (\n                f"Uma peça de corte a laser em {cat_display}, "\n                "criada para ser única e transmitir afeto em cada detalhe."\n            )\n            perfeito = (\n                "Ideal como presente personalizado, decoração de ambiente "\n                "ou lembrança especial para quem você ama."\n            )\n\n        description = (\n            clean_name + "\\n\\n"\n            "\\U0001f3a8 Por Que Este Produto é Especial:\\n"\n            + especial + "\\n\\n"\n            "\\U0001f496 Perfeito Para:\\n"\n            + perfeito\n        )\n\n        database_ref.setdefault(project_path, {})\n        database_ref[project_path]["ai_description"]           = description\n        database_ref[project_path]["description_generated_at"] = datetime.now().isoformat()\n        return description\n