"""\nCore ‚Äî Ollama Vision\nAn√°lise de imagem com moondream + filtro de qualidade\n"""\n\nimport os\nimport base64\nimport io\nfrom PIL import Image, ImageStat\nfrom config import LOGGER\n\n\nclass OllamaVision:\n    def __init__(self, ollama_client):\n        self.client = ollama_client\n\n    def image_quality_score(self, image_path):\n        """\n        Avalia se a imagem tem qualidade suficiente para o Moondream analisar sem alucinar.\n        Retorna dict com m√©tricas e flag 'use_vision' (True = pode usar, False = ignora vis√£o).\n\n        Crit√©rios de rejei√ß√£o (imagem amb√≠gua para vis√£o):\n          - Brilho m√©dio > 210  (foto muito clara / fundo branco dominante)\n          - Satura√ß√£o m√©dia < 25 (quase monocrom√°tica)\n          - % de pixels brancos > 50% (mockup com fundo branco)\n        """\n        try:\n            with Image.open(image_path) as img:\n                img_rgb = img.convert("RGB")\n                w, h = img_rgb.size\n                # Analisa s√≥ a √°rea central (remove bordas com marca d'√°gua)\n                box = (int(w*0.05), int(h*0.10), int(w*0.75), int(h*0.90))\n                center = img_rgb.crop(box)\n\n                # Brilho m√©dio (canal L)\n                gray = center.convert("L")\n                stat_g = ImageStat.Stat(gray)\n                brightness = stat_g.mean[0]\n\n                # Satura√ß√£o m√©dia (canal S do HSV)\n                hsv = center.convert("HSV")\n                stat_s = ImageStat.Stat(hsv)\n                saturation = stat_s.mean[1]\n\n                # % pixels brancos (R,G,B todos > 220)\n                white_pct = (brightness / 255.0) * max(0, 1.0 - (stat_g.stddev[0] / 80.0))\n                white_pct_normalized = white_pct * 100\n\n                use_vision = not (\n                    brightness > 210 or\n                    saturation < 25  or\n                    white_pct_normalized > 50\n                )\n\n                LOGGER.info(\n                    f"üìä [quality] brilho={brightness:.1f} sat={saturation:.1f} fundo_branco~{white_pct_normalized:.1f}% ‚Üí vision={use_vision}"\n                )\n                return {\n                    "brightness": brightness,\n                    "saturation": saturation,\n                    "white_pct":  white_pct_normalized,\n                    "use_vision": use_vision,\n                }\n        except Exception as e:\n            LOGGER.warning(f"Falha em image_quality_score: {e}")\n            return {"brightness": 0, "saturation": 100, "white_pct": 0, "use_vision": True}\n\n    def describe_image(self, image_path):\n        """\n        Usa moondream:latest para descrever o OBJETO CENTRAL da imagem.\n        Prompt cir√∫rgico: ignora fundo, brinquedos e marcas d'√°gua.\n        S√≥ √© chamado quando image_quality_score aprova a imagem.\n        """\n        if not image_path or not os.path.exists(image_path):\n            return ""\n        if not self.client.is_available():\n            return ""\n\n        model = self.client.get_model_name("vision")\n        timeout = self.client.get_timeout("vision")\n        try:\n            with Image.open(image_path) as img:\n                img.thumbnail((512, 512), Image.Resampling.LANCZOS)\n                buf = io.BytesIO()\n                img.save(buf, format="JPEG", quality=85)\n                img_b64 = base64.b64encode(buf.getvalue()).decode("utf-8")\n\n            payload = {\n                "model":  model,\n                "prompt": (\n                    "Look only at the main laser-cut wooden object in the center of this image. "\n                    "Ignore the background, walls, stuffed animals, toys, watermarks and any text overlays. "\n                    "Describe ONLY the central object: its shape, theme and style. "\n                    "One short sentence. Be specific and factual."\n                ),\n                "images": [img_b64],\n                "stream": False,\n                "options": {"temperature": 0.2, "num_predict": 60},\n            }\n            resp = self.client.session.post(\n                f"{self.client.base_url}/api/generate",\n                json=payload,\n                timeout=timeout,\n            )\n            if resp.status_code == 200:\n                vision_text = (resp.json().get("response") or "").strip()\n                LOGGER.info(f"üëÅÔ∏è [moondream] {vision_text[:80]}")\n                return vision_text\n        except Exception as e:\n            LOGGER.warning(f"Falha ao descrever imagem com moondream: {e}")\n        return ""\n